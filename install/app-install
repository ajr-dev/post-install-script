#!/bin/bash

# shellcheck disable=SC2034
declare -f assertConfirmation &>/dev/null ||  source "$HOME/.dotfiles/install/declarations"

if assertConfirmation "Update the system?"; then
    echo "Updating the system"
    echo "========================================================================"
    sudo apt-get -y --force-yes update
    sudo apt-get -y --force-yes upgrade
    echo "========================================================================"
    echo "System updated"
    echo "========================================================================"
fi

# Linuxbrew
sudo apt-get install build-essential curl file git python-setuptools ruby
ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install)"

# TODO: check if not installed already
#if grep -q "^flags.*\ hypervisor\ " /proc/cpuinfo  &&  assertConfirmation "Install Virtual Machine extras?"; then
#source "$INSTALL/virtual-machine"
#fi

if ! (( ${autoConfirm:?} )); then
    source "$INSTALL/remove-packages"
fi

source "$INSTALL/install-packages"

# TODO: fix jDownloader installation
#if [ ! -d ~/Downloads/jd2 ]  &&  assertConfirmation "Install jDownloader?"; then
#    source "$DOTFILES/install/jdownloader-install" # TODO: Downloads may not exist.
#fi

if ! command_exists xflux; then
    source "$INSTALL/flux-install"
fi

if [ "${MACHINE_TYPE}" == 64 ]  &&  assertConfirmation "Install Google Chrome?"; then
    sudo apt-get install libxss1 libappindicator1 libindicator7
    wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    sudo dpkg -i google-chrome*.deb
    sudo apt-get install -f
    rm google-chrome-stable_current_amd64.deb
    echo "========================================================================"
    echo "Gogle Chrome Installed"
    echo "========================================================================"
fi

if ! (( autoConfirm ))  &&  [ "${MACHINE_TYPE}" == 64 ]; then
    clear
    read -n 1 -p "Install Selenium? (yes/No) "
    printf '\n========================================================================'
    if [[ $REPLY =~ ^([Yy]|[Ss])$ ]]; then
        # Instalar xvfb
        sudo apt-get install xvfb
        # Instalar ChromeDriver
        wget -N http://chromedriver.storage.googleapis.com/2.20/chromedriver_linux64.zip
        unzip chromedriver_linux64.zip
        chmod +x chromedriver

        sudo mv -f chromedriver /usr/local/share/chromedriver
        rm chromedriver_linux64.zip
        sudo ln -s /usr/local/share/chromedriver /usr/local/bin/chromedriver
        sudo ln -s /usr/local/share/chromedriver /usr/bin/chromedriver
        echo "========================================================================"
    fi
fi

if ! command_exists dropbox  &&  assertConfirmation "Install Dropbox?"; then
    echo "deb [arch=i386,amd64] http://linux.dropbox.com/ubuntu wily main" | sudo tee -a /etc/apt/sources.list
    sudo apt-key adv --keyserver pgp.mit.edu --recv-keys 1C61A2656FB57B7E4DE0F4C1FC918B335044912E
    sudo apt-get -y update
    sudo apt-get -y install dropbox python-gpgme
    dropbox start -i
    sudo mv /etc/apt/sources.list /etc/apt/sources.list.bak
    sed '/dropbox/d' /etc/apt/sources.list.bak | sudo tee /etc/apt/sources.list
    if ! command_exists dropbox; then
        if [ "${MACHINE_TYPE}" == 64 ]; then
            dropbox="dropbox_2015.10.28_amd64.deb"
        else
            dropbox="dropbox_2015.10.28_i386.deb"
        fi
        wget https://www.dropbox.com/download?dl=packages/ubuntu/$dropbox
        sudo dpkg -i
        dropbox start -i
    fi
fi
