#!/bin/bash

source "$HOME/.dotfiles/install/declarations"

if assertConfirmation "Â¿Configure git?" "${autoConfirm:?}"; then
    source "$INSTALL/git-setup"
fi

if assertConfirmation "Import local config?" "${autoConfirm:?}"; then
    if [ -f ~/.dotfiles/local.vim ]  &&  [ -f ~/.dotfiles/local.zsh ]  &&  [ -f ~/.dotfiles/local.tmux ]; then
        cp ~/.dotfiles/local.vim ~/.local.vim
        cp ~/.dotfiles/local.zsh ~/.local.zsh
        cp ~/.dotfiles/local.tmux ~/.local.tmux
    else
        echo "Local configuration files don't exist" >&2
        exit
    fi
fi

if assertConfirmation "Configure vim?" "${autoConfirm:?}"; then
    source "$INSTALL/link-setup"
    # Terminal con cursiva
    cd ~/.dotfiles/tmux  ||  { echo "$HOME/.dotfiles/tmux doesn't exist" ; exit ; }
    tic xterm-256color-italic.terminfo
    mkdir -p ~/.tmux/resurrect
    [ ! -f ~/.dotfiles/tmux/last ]  &&  cp ~/.dotfiles/tmux/last ~/.tmux/resurrect/
    if [[ ! -d ~/.tmux/plugins/tpm ]]; then
        git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
    fi

    #if [[ ! -e ~/.vimrc  &&  ! -d ~/.vim  &&  ! -d ~/.config/nvim/ ]]; then
    if assertConfirmation "Install neovim?" "${autoConfirm:?}"; then
        source "$INSTALL/neovim-install"
    fi
    source "$INSTALL/vim-setup"
fi

if assertConfirmation "Change default shell to zsh?" "${autoConfirm:?}"; then
    if ! [[ $SHELL =~ .*zsh.* ]]; then
        echo "Configuring zsh as default shell"
        chsh -s "$(which zsh)"
    fi

    if ! command_exists zplug; then
        echo "installing zplug, a plugin manager for zsh - http://zplug.sh"
        git clone https://github.com/zplug/zplug ~/.zplug
    fi
fi

if assertConfirmation "Add powerline fonts?" "${autoConfirm:?}"; then
    git clone https://github.com/powerline/fonts ~/Downloads/fonts
    cd ~/Downloads/fonts || { echo "No existe el directorio fonts" ; exit ; }
    ./install.sh
    cd ..
    rm -rf fonts
    if [[ $OS == "cinnamon" ]]; then
        source "$INSTALL/settings-cinnamon"
    elif [[ $OS == "mate" ]]; then
        source "$INSTALL/settings-mate"
    fi
    if assertConfirmation "Unattended upgrades?" "${autoConfirm:?}"; then
        source "$INSTALL/unattended-upgrades"
    echo "========================================================================"
fi
fi

if assertConfirmation "Never ask for passwords?"; then
    source "$INSTALL/no-password-prompt"
fi

# Update automatically everyday at 14:30
[ ! -f /etc/crontab.bak ]  &&  sudo cp /etc/crontab /etc/crontab.bak  &&  echo "30 14 * * * root apt-get update" | sudo tee -a /etc/crontab

if assertConfirmation "Firefox setup?"; then
    source "$INSTALL/firefox-setup"
fi
